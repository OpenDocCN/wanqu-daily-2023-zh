# 使用 Ruby 和 Rails 构建 GitHub - GitHub 博客

> 原文链接：[`github.blog/2023-04-06-building-github-with-ruby-and-rails/`](https://github.blog/2023-04-06-building-github-with-ruby-and-rails/)

从一开始，GitHub.com 就是一个基于 Ruby on Rails 的单体应用。如今，该应用几乎有两百万行代码，每天有超过 1,000 名工程师在其中协作。我们每天部署多达 20 次，几乎每周都有一次部署是 Rails 升级。

## 每周升级 Rails

每周一，一个[预定的 GitHub Action 工作流](https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#schedule)触发一个自动化拉取请求，将我们的 Rails 版本升级到当天 Rails 主分支上的最新提交。我们所有的构建都在这个新版本的 Rails 上运行。一旦所有构建通过，我们审查更改并在第二天发布。从周一开始升级，您将已经有一个打开的拉取请求，链接到这次 Rails 升级提议的更改和一个已完成的构建。

这个过程与我们几年前进行 Rails 升级的方式有很大不同。过去，我们花了几个月从我们的自定义 Rails 分支迁移到更新的稳定版本，然后我们维护两个 Gemfiles 以确保与即将发布的版本兼容。现在，升级只需要不到一周的时间。您可以在这篇[2018 年的博客文章](https://github.blog/2018-09-28-upgrading-github-from-rails-3-2-to-5-2/)中了解更多关于这个过程的信息。我们与社区密切合作，确保每个 Rails 发布版本在正式发布之前在生产环境中运行。

运行最新版本的 Rails 有真正的实际好处：

+   **我们为 GitHub 的开发人员提供我们工具的最佳版本**，提供最新版本的 Rails。这确保用户可以利用所有最新的改进，包括更好的数据库连接处理、更快的视图渲染，以及每天在 Rails 中发生的所有令人惊叹的工作。

+   **我们几乎已经移除了所有的 Rails 补丁**。由于我们正在运行最新版本的 Rails，而不是打补丁并等待变更，开发人员可以向 Rails 本身建议补丁。

+   **现在与团队分享 Rails 的工作比以往任何时候都更容易**！不再需要告诉团队你在 Rails 中发现了一个将在下一个版本中修复的问题，你可以在 Rails 中处理某些事情，并在下周看到结果！

+   **保持更为更新的依赖关系可以提升我们的安全性**。由于我们已经每周进行升级，当有安全公告时进行升级是标准做法，不需要额外工作。

+   **没有“大爆炸”式的迁移**。由于每次 Rails 升级只包含少量更改，如果存在不兼容性，更容易理解和深入挖掘。*从一次艰难的升级中产生的最糟糕问题是来自未知位置的意外更改*。这些问题可以通过这种升级策略来缓解。

+   **在主分支中捕捉错误并贡献回来** 加强了我们的工程团队，并帮助我们的开发人员加深对我们的应用程序及其依赖关系的专业知识和理解。

## 持续测试 Ruby

当然，我们对 Ruby 升级也有类似的过程。2022 年 2 月，就在升级到 Ruby 3.1 后不久，我们开始在并行构建中构建和测试来自 3.2-alpha 的 Ruby shas。当 CI 运行 GitHub Rails 应用程序时，会运行两个版本的构建：一个构建使用我们在生产中运行的 Ruby 版本，另一个使用包括 Ruby 最新更改的最新 Ruby 提交，我们每周更新。

虽然我们每次更改都会构建 Ruby，但 GitHub 只会将带有编号的 Ruby 版本发布到生产环境。这些构建帮助我们保持与即将发布的 Ruby 版本的兼容性，并让我们了解即将到来的 Ruby 更改。

2022 年 12 月初，通过 CI 让我们在通常的圣诞节发布 Ruby 3.2 之前就有了兼容性的信心，我们能够使用部分生产流量测试 Ruby 的发布候选版本，并向 Ruby 团队提供我们注意到的任何变化。例如，我们可以重现由于这一过程而在 Ruby 3.2 发布前修复的[由于关键字参数处理而导致的分配增加](https://bugs.ruby-lang.org/issues/19165)。我们还确定了当[`to_str`和`#to_i`被应用时的微妙变化](https://github.com/ruby/ruby/commit/7563604fb868d87057733f52d780d841fc1ab6bb)。因为我们一直在升级，识别和解决这些问题是标准做法。

这种每周升级 Ruby 的过程使我们能够在发布一个月内将我们的单体应用从 Ruby 3.1 升级到 Ruby 3.2。毕竟，我们已经在生产中测试并运行了它！在这一点上，这是我们**迄今为止做过的最快的 Ruby 升级**。我们在 Ruby 3.2.1 发布当天打破了这一记录，我们**在发布当天**就采用了它。

这种升级过程已被证明对我们与 Ruby 核心团队的合作是非常宝贵的。拥有这些构建的一个好处是，我们能够在向上建议之前轻松测试和分析我们自己的 Ruby 更改。这可以帮助我们更容易地识别我们自己应用程序中的回归，并更好地了解更改对生产环境的影响。

## 我也应该这样做吗？

我们能够频繁升级 Ruby 和 Rails 的能力归功于 GitHub 的一些工程成熟度。每周升级 Rails 需要一个全面的测试套件，许多优秀的工程师致力于维护和改进它。我们还从拥有出色的测试环境以及渐进式部署中获得信心。我们的测试套件很可能会捕捉问题，如果没有，我们有信心在将其交付给客户之前在部署过程中捕捉到它。

如果您拥有这些工具，您还应该每周升级 Rails，并使用最新的 Ruby 进行测试。GitHub 是一个更好的 Rails 应用程序，因为它使得我的团队能够进行我真正引以为傲的工作。

Ruby 冠军 Eileen Uchitelle 在她的[Rails Conf 2022 主题演讲](https://www.youtube.com/watch?v=MbqJzACF-54)中解释了为什么投资于 Rails 是重要的：

最终，如果更多公司将框架视为应用程序的延伸，将会导致更高的弹性和稳定性。投资于 Rails 可以确保您的基础不会在应用程序的重压下崩溃。将其视为应用程序中不重要的部分是一个错误，许多领导者都犯了这个错误。

多亏了来自世界各地的人们的贡献，使用 Ruby 比以往任何时候都更好。GitHub 以及其他数百家公司受益于 Ruby 和 Rails 不断改进。定期升级并投资于我们的框架是我们在 GitHub Ruby 架构团队所做工作的重要组成部分。我们始终感激 Ruby 社区，并很高兴我们能以一种改进我们的应用程序和工具的方式回馈，就像它为其他人改进它们一样。
